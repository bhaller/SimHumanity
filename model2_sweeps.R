# model2_sweeps.R
#
# Benjamin C. Haller, 22 June 2025
#
# This R script has the raw data for all beneficial substitutions from model 2 (as shown in Fig. 2).
# After getting the data into a usable form, maybe we can find something to do with it...?  This
# really goes beyond the scope of the paper, though; we're not trying to find interesting results,
# we're just trying to show off the models themselves.  So this is not for publication, just for fun.

library("viridis")


# raw data from the end of model 2, for all beneficial substitutions

positions <- as.integer(unlist(strsplit("39120340 99690262 197512093 30555720 39407137 50631418 58681784 71690668 2709641 190609003 19319671 38054239 35910426 96280780 104949003 4499097 74783054 195770235 30455201 96879989 74762230 39906126 18247749 47888054 161021010 45931217 96987420 34112167 116457760 79082941 100165912 49811444 113942197 48739156 144312020 113582003 19698416 52115339 71714759 42730540 83471651 229659223 130568104 68554799 18317737 156969352 129637969 128107299 97873505 1589606 80472852 105924834 231208966 99908004 44055187 41886298 1367181 57156824 105007316 55092884 152350325 59773840 22209373 29049233 69333595 14404504 35862011 21513464 10455075 42212396 16399374 22976239 55154195 110212203 35309993 49290267 57179826 31965992 3205083 30309279 10503162 139481169 40302739 40838355 2185030 112514698 124549779 10276440 37010229 81330497 136521315 47635629 55856188 227735046 130305907 66990461 75183552 103946833 46624095 29457994 158123838 49186030 6121460 132140170 138071808 206770115 47285454 44313279 18264554 54145970 113297969 932080 108226731 74525535 164841975 109449349 63985093 6234965 23423917 28954670 35021588 53822174 28614663 96157206 133638158 15464331 92398681 79080980 44109130 88886091 164508546 93881546 40998079 100205740 47834458 55692001 138286768 102944290 68325542 201687352 69103999 124554391 151381339 68752885 110952056 46470682 92655409 8059134 39032219 1507632 103310314 23145909 122897462 48681539 36480575 106612436 62580611 14670071 2159982 64340297 13934231 24216228 63977000 10304121 102686065 157203878 100436056 30409201 108265315 133350695 42141572 84129747 134785474 135189822 90091593 152416599 63535785 7229996 71561791 49256135 113650427 132898365 143214848 44500410 31526395 1054598 31094614 40391519 156139836 57120795 64224526 31150107 57141425 43329270 51048849 19835644 46803002 73592359 30889269 116015669 32696595 223998308 109192792 6998530 10151514 57532266 71368161 66871119 7368762 107571166 85847998 15778506 96816876 93134723 41256803 17800069 42223318 37936757 10407631 37473592 62560387 94039902 43441247 160098411 31379860 102865933 58537883 218661153 109979446 101686805 75360657 165188485 141422533 97651099 54190751 10770315 43427438 2098920 184855761 3137439 51155696 38691374 78101124 178383220 102842885 95606299 107601535 47113001 42759107 43936540 41537092 71033520 47449016 28720724 66668943 12322661 29490847 177273577 49884156 155610461 158645226 104497664 21106603 100569710 58433226 95173307 67495876 11664910 110124166 41505267 102914799 52132008 151954908 104949441 52404242 150441922 69187213 35878577 63202776 128471377 462389 39337167 18245976 687366 128871800 16148651 22617490 46787542 52115309 152176634 21405775 28585338 106248242 15374002 150392038 87243545 61214448 41931885 1261604 135786453 22593796 85700526 57179545 124682208 120539355 46987547 67431328 70828325 31484906 136694197 77312137 130626541 24872912 112605578 22318998 72312315 228159065 119676920 140402023 75231856 24119817 64340751 103079869 41970381 21445547 111758828 57940974 121330453 45327161 57482570 179813789 48379515 123575765 148487689 132402111 31631026 135294099 152433836 74594359 82049031 128099195 201545619 27377214 151355849 35189836 3850192 52645153 49065598 163074353 35062071 178581653 2556671 46321864 31557807 44032838 165668947 6544945 19782008 48237005 108930131 109888117 68425157 112039268 43573374", " ", fixed=T)))

originTick <- as.integer(unlist(strsplit("87 1047 692 932 1151 1298 1557 2788 2443 2585 3176 3061 1778 2718 2695 2817 2543 2953 3142 3767 4088 3984 2944 4847 4826 5977 5584 3358 6244 5585 5529 5942 5865 7395 3360 5064 6085 7191 5739 6717 6322 8195 8255 7911 8830 9176 9079 8671 7268 6953 8869 9805 8805 9128 7482 9036 10383 11502 11164 10789 12938 12584 13031 12860 14379 14487 14145 12947 14460 13974 14718 4175 15056 14541 15698 15407 13518 15707 16467 16796 16563 14658 15956 16710 16825 18094 18688 17606 18693 18330 18409 17398 19437 19358 19141 18330 18055 18509 19134 18081 17138 17884 18668 20827 17876 20202 20409 21402 20433 20468 20727 22129 21398 22865 22243 22554 21638 23023 22511 25126 20586 25260 24979 25517 25635 24804 25725 25785 27370 27665 27917 28858 29056 28276 28810 29546 29398 29891 29972 29513 30636 30774 30504 30176 29836 30659 21709 29196 29944 30914 27671 32098 32555 31170 32356 33283 31569 33708 33724 33092 32321 33995 33970 33423 34727 34752 33176 37091 36646 35282 37805 37730 37892 38625 38147 38854 40354 39637 40874 38429 41473 39124 41238 40777 41281 42035 40553 34779 40083 40784 41739 43021 42720 43682 43532 43899 41829 44030 43827 44248 44601 46112 43993 44044 45841 46574 47135 47336 46693 46989 47290 47034 48137 48521 46712 48741 48391 48945 49532 49149 49883 49567 49578 48276 49643 49234 50172 50728 50821 51383 51463 51534 50904 50861 50397 51830 51933 49494 49377 52033 48720 52975 50681 53811 48880 54254 54384 55635 56052 53976 55028 55658 56898 54541 54184 56710 56213 56401 57294 56414 57477 57849 57369 58240 56708 57704 57467 58601 58438 59679 59017 58791 58441 59130 55053 56314 59201 60537 60031 60420 56185 59665 62700 63803 62710 63539 61745 60685 60951 64589 63669 64913 62630 65014 65414 64954 64856 66206 65622 64990 67663 67479 66363 62449 66229 69283 68617 68168 68879 70111 65285 68828 70621 71209 71210 70322 69442 71571 72390 71815 71924 72753 73392 73668 72824 72342 72566 74635 73866 73890 74216 73752 74444 74166 74752 71018 73522 74865 74827 75257 73111 74187 73596 74980 74441 74140 75593 75698 73962 76002 73073 76174 75713 75242 73071 76932 76911 75297 76860 72635 76537 73619 76707 76421", " ", fixed=T)))

fixationTick <- as.integer(unlist(strsplit("581 1522 1879 2005 2368 2831 3281 3346 3593 3603 3659 3692 3727 3745 3759 3958 4242 4691 5181 5286 5730 5791 5874 6079 6116 6522 6598 6996 7099 7164 7250 7369 7415 7837 7879 7962 7984 8004 8090 8194 8204 8946 9020 9092 9598 9710 9956 10269 10326 10373 10431 10645 10805 11127 11187 11318 11615 12176 12406 12593 13900 13920 14291 14356 14864 15056 15070 15256 15278 15638 15643 15688 15760 16364 16682 16684 16819 16963 17343 17881 17933 17935 18208 18383 18498 18700 19213 19369 19562 19703 19717 19956 20008 20033 20076 20078 20208 20552 20597 20844 21101 21285 21381 21549 21723 21914 21947 22045 22137 22197 22213 22655 22746 23263 23689 23761 24145 24187 25551 25708 26029 26054 26188 26235 26281 26481 27387 27904 28068 28557 29045 29803 30162 30311 30436 30568 30628 30909 31031 31079 31359 31514 31548 31935 32179 32183 32247 32298 32349 32416 32860 33141 33442 33641 33690 33867 33875 34340 34392 34457 34607 34946 34965 35082 35252 35709 36241 37633 37674 38479 39539 39756 39943 39992 40083 40890 41174 41182 41673 42280 42300 42531 42597 42869 42929 42960 43022 43107 43240 43444 43759 43764 44073 44244 44532 44729 45102 45538 45794 46444 46591 46796 46988 47002 47236 47322 48029 48200 48508 48631 48644 48719 49059 49277 49370 49426 49665 49892 50170 50174 50474 50568 50870 51306 51328 51463 51553 51659 52041 52152 52223 52278 52341 52403 52659 52696 52776 52907 52945 53179 53915 53968 54247 54358 54715 55424 55898 56525 56617 56967 57090 57201 57386 57403 57522 57580 57712 58177 58267 58294 58689 58801 58802 58825 58906 58919 59105 59623 59795 60029 60061 60106 60295 60442 60444 60460 60717 61359 61598 61874 61949 62964 63754 64276 64758 64762 64848 65094 65554 65645 65696 66135 66207 66207 66295 66339 67057 67085 67313 67603 68460 68787 68893 69018 69841 69988 70199 70575 70894 70898 71101 71187 71589 71893 71910 72226 72736 72765 72790 72934 73471 74106 74288 74539 74610 74703 75061 75178 75221 75224 75272 75605 75779 75796 75839 75899 75993 76089 76116 76235 76250 76320 76443 76606 76722 76725 76750 76868 76890 76964 77008 77106 77157 77403 77403 77463 77703 77809 77953 78193 78308 78690 78841 78924", " ", fixed=T)))

chromosome_id <- as.integer(unlist(strsplit("2 15 3 16 4 15 1 16 7 3 8 23 5 12 14 17 5 3 7 8 9 17 17 23 1 22 13 11 23 5 8 3 2 15 8 10 7 19 16 3 11 1 3 17 17 1 9 10 3 16 5 23 1 10 19 17 19 12 11 1 6 17 10 22 14 19 19 20 17 22 1 19 19 6 19 19 12 6 16 23 17 5 1 1 16 4 8 3 23 5 3 20 15 1 7 9 6 12 19 16 2 13 21 12 3 2 11 6 17 19 9 4 1 2 2 8 18 1 14 16 19 10 10 10 3 19 7 17 7 16 2 5 5 12 19 16 6 14 12 2 5 9 7 3 1 19 15 12 22 19 7 19 9 3 22 23 5 3 11 11 16 2 20 1 13 6 7 22 2 9 22 16 5 6 15 6 17 6 23 3 13 5 4 20 15 19 12 17 1 7 14 14 6 15 18 13 16 14 6 5 15 2 1 17 19 12 23 11 6 7 2 4 2 7 22 6 3 8 20 6 11 3 1 1 16 11 18 2 6 9 15 3 5 10 1 11 1 8 3 16 17 13 11 2 11 6 23 18 8 1 15 14 23 17 11 19 10 1 22 1 1 8 16 2 8 11 3 17 10 17 1 8 23 14 6 1 16 17 20 9 20 12 17 16 4 1 8 19 19 7 14 17 6 19 5 6 2 3 11 9 8 11 12 10 23 10 16 16 16 6 7 3 6 3 10 4 1 3 5 17 14 11 23 18 22 9 19 4 1 5 1 3 5 6 9 18 23 6 23 17 10 2 11 7 11 6 12 23 1 9 2 1 19 6 19 1 11 17 15 2 10 11 11 15", " ", fixed=T)))

selCoeff <- as.numeric(unlist(strsplit("0.0595978 0.0599581 0.0166352 0.0217045 0.025834 0.0167896 0.0150626 0.0613304 0.0188746 0.0193862 0.0668587 0.0274547 0.0112942 0.0229247 0.0272316 0.0234874 0.0128678 0.0141726 0.0230567 0.010192 0.0134355 0.0160838 0.00956602 0.0169571 0.01791 0.0535819 0.0176273 0.00737213 0.0218966 0.0179122 0.0149775 0.0159811 0.0128594 0.0633983 0.00337142 0.0095331 0.0124279 0.0266685 0.00768812 0.0155928 0.0145046 0.0375052 0.0337648 0.0210831 0.0319835 0.0498791 0.0264579 0.0112868 0.00436924 0.00551458 0.0126734 0.0275517 0.00829173 0.0089985 0.00771338 0.0122743 0.0171725 0.0417682 0.0168099 0.0107849 0.0273153 0.0192824 0.0189015 0.0108837 0.0648453 0.0486597 0.0392074 0.00948204 0.0318742 0.0130972 0.0269885 0.00206761 0.0420745 0.0149727 0.0250758 0.0115151 0.00729621 0.0179832 0.0276835 0.0176153 0.0146587 0.005797 0.00735464 0.0183327 0.015841 0.0447407 0.0555374 0.0123465 0.0289413 0.0154695 0.0231267 0.0109511 0.0521855 0.0343899 0.0239659 0.0099741 0.00785589 0.00775799 0.0140556 0.0103375 0.00876042 0.00539538 0.0073389 0.0293021 0.00570399 0.0122117 0.0161782 0.0438213 0.010909 0.0101513 0.0141637 0.0513828 0.0171013 0.0721368 0.0169344 0.0178922 0.0119934 0.0220726 0.00606197 0.0446247 0.00327453 0.0331893 0.0152789 0.0317298 0.0372695 0.0127071 0.0168182 0.00817807 0.0273666 0.02549 0.0268592 0.027808 0.0211888 0.00811952 0.0109679 0.0284315 0.0185599 0.027865 0.0196025 0.0143433 0.0289634 0.0292531 0.0238863 0.0094182 0.00624751 0.018029 0.00122763 0.00575802 0.0121238 0.0196469 0.0029039 0.022531 0.0226333 0.0100916 0.021008 0.0412437 0.00587817 0.0532713 0.0442803 0.0121124 0.00719586 0.0312 0.0196104 0.0128334 0.0443914 0.0327938 0.00557833 0.0507024 0.0226768 0.00809424 0.0235665 0.0132305 0.00830877 0.0162367 0.011161 0.0160562 0.032661 0.0181471 0.0166119 0.0052867 0.0373468 0.00735117 0.0190405 0.0136975 0.0181097 0.0263648 0.00911176 0.00178383 0.00461205 0.00619667 0.00923338 0.038456 0.014489 0.0442084 0.0279448 0.0226658 0.00784643 0.0172844 0.0184374 0.00849571 0.0108547 0.0416662 0.0067952 0.00680919 0.0210324 0.0295103 0.0208832 0.0334648 0.0105125 0.0128002 0.0137497 0.0146329 0.0386155 0.0399474 0.00907881 0.043401 0.0167949 0.0266239 0.0478359 0.0205671 0.0394587 0.0285919 0.0152928 0.00832666 0.0107689 0.0129391 0.0142846 0.0273403 0.0179678 0.0349511 0.0242808 0.0388194 0.0199119 0.0128903 0.00772244 0.025691 0.0235055 0.00562008 0.00559718 0.0203246 0.00322504 0.0208423 0.00534103 0.0414821 0.00490949 0.0179651 0.00968422 0.0279952 0.0534476 0.007021 0.0134577 0.0141954 0.0388695 0.0087847 0.00650771 0.024995 0.0198289 0.0120916 0.029153 0.0138397 0.0271629 0.0217083 0.0197419 0.0448412 0.0103255 0.0216608 0.01747 0.0239336 0.0159095 0.104466 0.0170334 0.0204022 0.00787911 0.0191315 0.0036511 0.00404011 0.0129261 0.0311549 0.0124315 0.0144405 0.0028759 0.00442625 0.0234281 0.0605572 0.0143751 0.018554 0.00735887 0.00485108 0.00446721 0.0238171 0.0136759 0.0232173 0.00325374 0.0147937 0.0278773 0.0190809 0.00980205 0.031328 0.0143876 0.0110028 0.0370901 0.0216144 0.00998591 0.00499514 0.00616508 0.0406709 0.0156651 0.0123109 0.00987693 0.045789 0.00357787 0.00635045 0.0261694 0.0415091 0.0321655 0.0126608 0.00709681 0.022942 0.0705601 0.0239266 0.0207119 0.0194936 0.0289651 0.0310462 0.017564 0.00878504 0.00985908 0.062642 0.0170696 0.0178221 0.0288795 0.014452 0.0215577 0.0154955 0.0272712 0.00461181 0.00597055 0.022982 0.0138074 0.0307008 0.0102282 0.0167018 0.0112879 0.0174349 0.0121656 0.00710115 0.0244899 0.0135602 0.00742599 0.0353865 0.00836166 0.0274737 0.0246657 0.0139729 0.00437967 0.0627025 0.0467804 0.0089584 0.023906 0.00392254 0.0164205 0.00358769 0.0178348 0.00974625", " ", fixed=T)))


# plot the duration of a sweep against its selection coefficient; a larger selection coefficient should tend to produce a faster sweep

duration <- fixationTick - originTick

plot(x=selCoeff, y=duration, pch=19, cex=0.3, col="red")


# add colors to the previous plot indicating how many other sweeps were happening at the same time

duration <- fixationTick - originTick

sweepCount <- NULL

for (i in seq_along(duration))
{
	this_origin <- originTick[i]
	this_fixation <- fixationTick[i]
	simultaneous <- (originTick <= this_fixation) & (fixationTick >= this_origin) & (seq_along(duration) != i)
	sweepCount <- c(sweepCount, sum(simultaneous))
}

maxCount <- max(sweepCount)
colors <- plasma(maxCount + 1)

plot(x=selCoeff, y=duration, pch=19, cex=0.3, col=colors[sweepCount + 1])


# instead, color by how much time is spent shared with other sweeps, weighted by the selection coefficients of those sweeps

duration <- fixationTick - originTick

sweepWeight <- NULL

for (i in seq_along(duration))
{
	this_origin <- originTick[i]
	this_fixation <- fixationTick[i]
	is_simultaneous <- (originTick <= this_fixation) & (fixationTick >= this_origin) & (seq_along(duration) != i)
	
	# this narrows down to just sweeps on the same chromosome; physical linkage should be important
	is_simultaneous <- is_simultaneous & (chromosome_id == chromosome_id[i])
	
	simul_origin <- originTick[is_simultaneous]
	simul_fix <- fixationTick[is_simultaneous]
	overlap <- pmin(this_fixation, simul_fix) - pmax(this_origin, simul_origin)
	weighted_overlap <- overlap * selCoeff[is_simultaneous]
	sweepWeight <- c(sweepWeight, sum(weighted_overlap))
}

# scale sweepWeight values by the duration of the focal mutation; the question is, *per* unit time
# spent sweeping, how many other sweeps are you sharing your duration with?
sweepWeight <- sweepWeight / (fixationTick - originTick)

# let's try a sqrt transform to bring out the detail at the low end more
sweepWeight <- sqrt(sweepWeight)

maxWeight <- max(sweepWeight)
colors <- plasma(100)

plot(x=selCoeff, y=duration, pch=19, cex=0.3, col=colors[(sweepWeight / maxWeight) * 99 + 1])


# this adds a color stripe showing the scale of the sweepWeight colors; toward black is a very low
# sweepWeight value, indicating that the sweep proceeded by itself, whereas towards yellow is a
# high sweepWeight value, indicating that the sweep was accompanied by many other sweeps
for (i in 0:99)
{
	bottom <- 3000 + (9000-3000) * (i / 100)
	top <- 3000 + (9000-3000) * ((i + 1) / 100)
	rect(xleft=0.10, ybottom=bottom, xright=0.105, ytop=top, col=colors[i+1], border=NA)
}
rect(xleft=0.10, ybottom=3000, xright=0.105, ytop=9000, border="black")


# this function is thanks to P. Messer, adapted a bit for use here; it simulates a bunch of sweep
# trajectories for the given parameters and returns the mean fixation time across 1000 runs
mean_fixation_time <- function(N, h, s)
{
	times <- c()
	
	i<-0
	
	while(i<1000)
	{
	  x <- 1/(2*N)
	  t <- 1
	
	  while(x>0 && x<1-1.000001/(2*N))		# allow for a bit of numerical error
	  {
	    #p <- ((1+s)*x^2 + (1+h*s)*x*(1-x)) / ((1+s)*x^2 + (1+h*s)*2*x*(1-x) + (1-x)^2)
	    p <- (1+h*s)*x/(1+h*s*x)
	    n <- rbinom(1,2*N,p)
	    x <- n/(2*N)
	    t <- t+1
	  }
	  
	  if(x>0) 
	  { 
	    i <- i+1
	    times <- c(times,t) 
	  }
	}
	return(mean(times));
}

time <- mean_fixation_time(N=7310, h=0.5, s=0.11)
print(time)


# use the above function to simulate sweeps for the range of s values spanning the plot
# note that this takes some time to complete; be patient!  :->?
Ne <- 7310	# the value of N for the bulk of the African population stage
selCoeffs <- seq(from=0.001, to=0.11, by=0.001)
expectedDurations <- sapply(selCoeffs, FUN = function(s) { mean_fixation_time(Ne, 0.5, s) })

lines(x=selCoeffs, y=expectedDurations, lwd=1.0, col="red")


# So, some partial conclusions.  It is certainly apparent that the low-s mutations are more likely to
# sweep together with other mutations.  But is this because for low s, you're likely to be lost unless
# you get helped by another sweep?  Or is this because for low s, your sweep duration is longer, and so
# you share your duration with more other sweeps just due to that?  I added the line:
#
#	sweepWeight <- sweepWeight / (fixationTick - originTick)
#
# to answer this, and with that line added, the pattern seems to me to disappear, although one would
# have to do stats to be sure.  But it doesn't look like there's a strong effect of needing help to
# complete for small s, nor does it look like there's a strong pattern of sweeping faster with other
# sweeps than by yourself.  Maybe a little bit, but not super obviously.
#
# The remaining question is why ALL of these sweeps are so much faster than expected according to
# the -4*Ne*ln(s) equation.  Perhaps I'm just using it wrong.




